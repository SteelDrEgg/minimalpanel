<!DOCTYPE html>
<html lang="en">

<head>
    <title>SSH Terminal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #ffffff;
            height: 100%;
            overflow: hidden;
        }

        .container {
            height: 100%;
        }

        .main-content {
            height: 100%;
        }

        .toolbar {
            background: #2d2d30;
            padding: 10px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terminal-container {
            background: #1e1e1e;
            padding: 10px;
            width: 100%;
            /* Height will be set by JavaScript */
        }

        #terminal {
            width: 100%;
            height: 100%;
        }

        .connection-form {
            background: #2d2d30;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #cccccc;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            background: #3c3c3c;
            border: 1px solid #464647;
            border-radius: 4px;
            color: #ffffff;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007acc;
        }

        .btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #005a9e;
        }

        .btn:disabled {
            background: #666666;
            cursor: not-allowed;
        }

        .btn-disconnect {
            background: #d73a49;
        }

        .btn-disconnect:hover {
            background: #b52d3a;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .status.connected {
            background: #28a745;
            color: white;
        }

        .status.disconnected {
            background: #6c757d;
            color: white;
        }

        .status.error {
            background: #dc3545;
            color: white;
        }

        .status.connecting {
            background: #ffc107;
            color: #212529;
        }

        .toggle-section {
            cursor: pointer;
            user-select: none;
            padding: 10px 0;
            border-bottom: 1px solid #3e3e42;
            margin-bottom: 15px;
        }

        .toggle-section:hover {
            background: #3e3e42;
        }

        .collapsible {
            display: none;
        }

        .collapsible.active {
            display: block;
        }

        .session-info {
            background: #2d2d30;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .session-info h3 {
            margin-bottom: 10px;
            color: #cccccc;
        }

        .session-info p {
            margin: 5px 0;
            color: #999999;
            font-size: 13px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 15px;
        }

        .auth-tab {
            flex: 1;
            padding: 8px 12px;
            background: #3c3c3c;
            border: 1px solid #464647;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            color: #cccccc;
        }

        .auth-tab.active {
            background: #007acc;
            color: white;
        }

        .auth-tab:first-child {
            border-radius: 4px 0 0 4px;
        }

        .auth-tab:last-child {
            border-radius: 0 4px 4px 0;
        }

        .auth-content {
            display: none;
        }

        .auth-content.active {
            display: block;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #252526;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #3e3e42;
        }

        .modal-header h2 {
            margin: 0;
            color: #ffffff;
            font-size: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: #cccccc;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #3e3e42;
            color: #ffffff;
        }

        .btn-connect {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            transition: background 0.2s ease;
        }

        .btn-connect:hover {
            background: #005a9e;
        }

        .btn-connect:disabled {
            background: #666666;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="main-content">
            <div class="toolbar">
                <div>
                    <span style="font-weight: bold;">SSH Terminal</span>
                    <span id="terminalTitle" style="margin-left: 10px; color: #999;">Not connected</span>
                    <div id="status" class="status disconnected" style="display: inline-block; margin-left: 15px; padding: 4px 8px; font-size: 12px;">Disconnected</div>
                </div>
                <div>
                    <button id="connectBtn" class="btn-connect" onclick="openConnectionModal()">Connect</button>
                    <button id="disconnectBtn" class="btn-connect btn-disconnect" onclick="disconnect()" style="display: none;">Disconnect</button>
                </div>
            </div>
            
            <div class="terminal-container">
                <div id="terminal"></div>
            </div>
        </div>
    </div>

    <!-- Connection Modal -->
    <div id="connectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>SSH Connection</h2>
                <button class="modal-close" onclick="closeConnectionModal()">&times;</button>
            </div>
            
            <div class="connection-form">
                <div class="form-group">
                    <label for="host">Host</label>
                    <input type="text" id="host" placeholder="e.g., example.com" value="localhost">
                </div>

                <div class="form-group">
                    <label for="port">Port</label>
                    <input type="number" id="port" placeholder="22" value="22">
                </div>

                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter username">
                </div>

                <div class="auth-tabs">
                    <div class="auth-tab active" onclick="switchAuthTab('password')">Password</div>
                    <div class="auth-tab" onclick="switchAuthTab('key')">Private Key</div>
                </div>

                <div id="password-auth" class="auth-content active">
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" placeholder="Enter password">
                    </div>
                </div>

                <div id="key-auth" class="auth-content">
                    <div class="form-group">
                        <label for="privateKey">Private Key Path</label>
                        <input type="text" id="privateKey" placeholder="e.g., ~/.ssh/id_rsa">
                    </div>
                    <div class="form-group">
                        <label for="passphrase">Passphrase (optional)</label>
                        <input type="password" id="passphrase" placeholder="Enter passphrase if required">
                    </div>
                </div>

                <button class="btn" style="width: 100%; margin-top: 20px;" onclick="connectFromModal()">Connect</button>
            </div>

            <div class="session-info" id="sessionInfo" style="display: none; margin-top: 20px;">
                <h3>Session Info</h3>
                <p id="sessionHost">Host: -</p>
                <p id="sessionUser">User: -</p>
                <p id="sessionPort">Port: -</p>
                <p id="sessionTime">Connected: -</p>
            </div>
        </div>
    </div>

    <!-- Socket.IO and Xterm.js -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>

    <script>
        // Terminal setup
        const term = new Terminal({
            cursorBlink: true,
            theme: {
                background: '#1e1e1e',
                foreground: '#ffffff',
                cursor: '#ffffff',
                selection: '#444444',
                black: '#000000',
                red: '#ff0000',
                green: '#00ff00',
                yellow: '#ffff00',
                blue: '#0000ff',
                magenta: '#ff00ff',
                cyan: '#00ffff',
                white: '#ffffff',
                brightBlack: '#555555',
                brightRed: '#ff5555',
                brightGreen: '#55ff55',
                brightYellow: '#ffff55',
                brightBlue: '#5555ff',
                brightMagenta: '#ff55ff',
                brightCyan: '#55ffff',
                brightWhite: '#ffffff'
            },
            allowTransparency: true,
            fontSize: 14,
            fontFamily: 'Menlo, Monaco, "Courier New", monospace'
        });

        // Load the fit addon
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        term.open(document.getElementById('terminal'));
        
        // Initial terminal size
        console.log('Initial terminal size:', term.cols, 'x', term.rows);
        
        term.write('SSH Terminal - Click Connect to start a session.\r\n');

        // Socket.IO setup
        let socket = null;
        let connected = false;
        let connectionStartTime = null;

        // Form elements
        const hostInput = document.getElementById('host');
        const portInput = document.getElementById('port');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const privateKeyInput = document.getElementById('privateKey');
        const passphraseInput = document.getElementById('passphrase');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const statusDiv = document.getElementById('status');
        const sessionInfo = document.getElementById('sessionInfo');

        // Modal functions
        function openConnectionModal() {
            document.getElementById('connectionModal').classList.add('active');
        }

        function closeConnectionModal() {
            document.getElementById('connectionModal').classList.remove('active');
        }

        function connectFromModal() {
            connect();
            // Don't close modal immediately - wait for connection result
        }

        // Authentication tab switching
        function switchAuthTab(authType) {
            // Update tab buttons
            document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.auth-content').forEach(content => content.classList.remove('active'));
            document.getElementById(authType + '-auth').classList.add('active');
        }

        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('connectionModal');
            if (event.target === modal) {
                closeConnectionModal();
            }
        });

        // Close modal on Escape key
        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeConnectionModal();
            }
        });

        // Update status display
        function updateStatus(status, message) {
            statusDiv.className = `status ${status}`;
            statusDiv.textContent = message;
        }

        // Update session info
        function updateSessionInfo(info) {
            if (info) {
                document.getElementById('sessionHost').textContent = `Host: ${info.host}`;
                document.getElementById('sessionUser').textContent = `User: ${info.user}`;
                document.getElementById('sessionPort').textContent = `Port: ${info.port}`;
                document.getElementById('sessionTime').textContent = `Connected: ${new Date().toLocaleTimeString()}`;
                document.getElementById('terminalTitle').textContent = `${info.user}@${info.host}:${info.port}`;
                sessionInfo.style.display = 'block';
            } else {
                sessionInfo.style.display = 'none';
                document.getElementById('terminalTitle').textContent = 'Not connected';
            }
        }


        // Terminal resize handling
        let resizeTimeout = null;
        const CHAR_WIDTH = 8.4;   // Character width in pixels
        const CHAR_HEIGHT = 17;   // Character height in pixels
        const PADDING = 20;       // Container padding
        
        function resizeTerminal() {
            // Calculate available space
            const width = window.innerWidth - PADDING;
            const height = window.innerHeight - document.querySelector('.toolbar').offsetHeight - PADDING;
            
            // Convert to terminal size
            const cols = Math.floor(width / CHAR_WIDTH);
            const rows = Math.floor(height / CHAR_HEIGHT);
            
            console.log(`Resize: ${width}x${height}px → ${cols}x${rows} chars`);
            
            if (cols > 0 && rows > 0) {
                // Send to backend
                if (connected && socket) {
                    socket.emit('resize', { cols, rows });
                }
                
                // Resize terminal
                term.resize(cols, rows);
            }
        }

        // Debounced resize - wait for resize to finish
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(resizeTerminal, 300);
        });

        // Terminal input handler
        term.onData(data => {
            if (connected && socket) {
                socket.emit('terminal_input', data);
            }
        });

        // Connect function
        function connect() {
            if (connected) return;

            const host = hostInput.value.trim();
            const port = portInput.value.trim() || '22';
            const username = usernameInput.value.trim();

            if (!host || !username) {
                updateStatus('error', 'Host and username are required');
                return;
            }

            updateStatus('connecting', 'Connecting...');
            connectBtn.disabled = true;

            // Initialize socket connection
            socket = io('/ssh', {
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                console.log('Socket connected');
                
                // Prepare connection data
                const connectionData = {
                    host: host,
                    port: port,
                    username: username
                };

                // Add authentication data based on selected tab
                if (document.getElementById('password-auth').classList.contains('active')) {
                    connectionData.password = passwordInput.value;
                    console.log('Using password authentication');
                } else {
                    connectionData.privateKey = privateKeyInput.value.trim();
                    connectionData.passphrase = passphraseInput.value;
                    console.log('Using private key authentication, key path:', connectionData.privateKey, 'has passphrase:', !!connectionData.passphrase);
                }

                console.log('Sending connection data:', connectionData);
                
                // Send connection request
                socket.emit('connect_ssh', connectionData);
            });

            socket.on('ssh_connected', (data) => {
                connected = true;
                connectionStartTime = new Date();
                updateStatus('connected', 'Connected');
                updateSessionInfo(data);
                
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
                
                // Close the connection modal on success
                closeConnectionModal();
                
                term.clear();
                term.write('Connected to ' + data.user + '@' + data.host + ':' + data.port + '\r\n');
                term.focus();
                
                // Size terminal on connect
                setTimeout(() => {
                    resizeTerminal();
                }, 200);
            });

            socket.on('ssh_error', (error) => {
                console.error('SSH Error:', error);
                updateStatus('error', 'Error: ' + error);
                connectBtn.disabled = false;
                
                if (socket) {
                    socket.disconnect();
                    socket = null;
                }
            });

            socket.on('terminal_output', (data) => {
                term.write(data);
            });

            socket.on('disconnect', () => {
                console.log('Socket disconnected');
                if (connected) {
                    disconnect();
                }
            });

            socket.on('connect_error', (error) => {
                console.error('Socket connection error:', error);
                updateStatus('error', 'Socket connection failed: ' + error.message);
                connectBtn.disabled = false;
            });

            socket.on('error', (error) => {
                console.error('Socket error:', error);
                updateStatus('error', 'Socket error: ' + error);
            });
        }

        // Disconnect function
        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }

            connected = false;
            connectionStartTime = null;
            
            updateStatus('disconnected', 'Disconnected');
            updateSessionInfo(null);
            
            connectBtn.style.display = 'block';
            connectBtn.disabled = false;
            disconnectBtn.style.display = 'none';
            
            term.clear();
            term.write('SSH Terminal - Click Connect to start a session.\r\n');
        }

        // Handle Enter key in form inputs
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !connected) {
                    connect();
                }
            });
        });

        // Initial terminal focus
        term.focus();

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (connected && socket) {
                socket.disconnect();
            }
        });
    </script>
</body>

</html>
