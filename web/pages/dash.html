<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
        :root {
            --border-color: #e5e5e5;
            --text-secondary: #737373;
            --text-primary: #0a0a0a;
            --background-white: white;
            --background-light: #f8fafc;
            --background-page: white;
            --green-primary: #87ce15;
            --green-light: #87ce157b;
            --shadow-light: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--background-page);
            color: #334155;
            line-height: 1.6;
        }

        /* Top Bar */
        .top-bar {
            background: var(--background-white);
            border-bottom: 1px solid var(--border-color);
            padding: 0.6rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .heartbeat {
            position: relative;
            width: 12px;
            height: 12px;
            background-color: var(--green-primary);
            border-radius: 50%;
        }

        .heartbeat::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .heartbeat.connected::before {
            background-color: var(--green-light);
            animation: radiativePulse 1.5s infinite;
        }

        @keyframes radiativePulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.8;
            }
            70% {
                transform: translate(-50%, -50%) scale(3);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(3);
                opacity: 0;
            }
        }

        .system-info {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            font-weight: 200;
            color: var(--text-primary);
            flex-wrap: wrap;
        }

        .refresh-controls {
            position: relative;
            display: inline-block;
        }

        .combined-refresh-button {
            background: var(--background-white);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.625rem;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: stretch;
            overflow: hidden;
            height: 36px;
            box-shadow: var(--shadow-light);
        }

        .refresh-icon-section {
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            height: 100%;
        }

        .refresh-icon-section:hover {
            background: var(--background-light);
        }

        .refresh-icon {
            width: 16px;
            height: 16px;
        }

        .separator {
            width: 1px;
            background: var(--border-color);
            align-self: stretch;
        }

        .dropdown-section {
            padding: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 60px;
            justify-content: center;
            transition: background-color 0.2s;
            height: 100%;
        }

        .dropdown-section:hover {
            background: var(--background-light);
        }

        .dropdown-content {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--background-white);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 120px;
            display: none;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: var(--background-light);
        }

        .dropdown-item.active {
            background: #eff6ff;
            color: #2563eb;
        }

        /* Main Content */
        .main-content {
            width: 95%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem 0;
        }

        /* Card System */
        .card-row {
            display: grid;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .card-row.cols-1 {
            grid-template-columns: 1fr;
        }

        .card-row.cols-2 {
            grid-template-columns: 1fr 1fr;
        }

        .card-row.cols-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }

        @media (max-width: 1024px) {
            .card-row.cols-3 {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .card-row.cols-2,
            .card-row.cols-3 {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                width: 90%;
                padding: 1rem 0;
            }
            
            .top-bar {
                padding: 1rem;
                flex-wrap: wrap;
                justify-content: space-between;
                align-items: center;
            }
            
            .status-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                font-size: 0.75rem;
            }
            
            .system-info {
                flex-direction: column;
                gap: 0.25rem;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                width: 85%;
            }
        }

        .card {
            background: var(--background-white);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-light);
            overflow: hidden;
        }

        .card.bordered {
            border: 1px solid var(--border-color);
        }

        .card.invisible {
            background: transparent;
            box-shadow: none;
            border: none;
        }

        .card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f1f5f9;
            background: var(--background-light);
        }

        .card.invisible .card-header {
            padding: 1rem 0;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-content {
            padding: 1.5rem;
        }

        .card.invisible .card-content {
            padding: 1.5rem 0;
        }

        .greeting {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .greeting-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Metric Cards */
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .metric-bar {
            width: 100%;
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .metric-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .metric-bar-fill.cpu {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .metric-bar-fill.memory {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
        }

        .metric-bar-fill.disk {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .arrow-down {
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="status-info">
            <div class="heartbeat" id="heartbeat"></div>
            <div class="system-info">
                <span id="current-ip">192.168.1.100</span>
                <span>Hostname: <span id="hostname">server-01</span></span>
            </div>
        </div>
        
        <div class="refresh-controls">
            <div class="combined-refresh-button">
                <div class="refresh-icon-section" onclick="refreshData()">
                    <svg class="refresh-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path d="M20.5 8c-1.392-3.179-4.823-5-8.522-5C7.299 3 3.453 6.552 3 11.1"/><path d="M16.489 8.4h3.97A.54.54 0 0 0 21 7.86V3.9M3.5 16c1.392 3.179 4.823 5 8.522 5c4.679 0 8.525-3.552 8.978-8.1"/><path d="M7.511 15.6h-3.97a.54.54 0 0 0-.541.54v3.96"/></g></svg>
                </div>
                <div class="separator"></div>
                <div class="dropdown-section" onclick="toggleDropdown()">
                    <span id="current-rate">10s</span>
                    <div class="arrow-down"></div>
                </div>
            </div>
            <div class="dropdown-content" id="refreshDropdown">
                <div class="dropdown-item active" onclick="setRefreshRate('10s')">10s</div>
                <div class="dropdown-item" onclick="setRefreshRate('3s')">3s</div>
                <div class="dropdown-item" onclick="setRefreshRate('OFF')">OFF</div>
                <div class="dropdown-item" onclick="setRefreshRate('custom')">Custom</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Greeting Section -->
        <div class="card-row cols-1">
            <div class="card invisible">
                <div class="card-content">
                    <div class="greeting">Good <span id="time-of-day">morning</span>, <span id="username">Administrator</span>!</div>
                    <div class="greeting-subtitle">Welcome back to your dashboard</div>
                </div>
            </div>
        </div>

        <!-- System Metrics -->
        <div class="card-row cols-3">
            <div class="card bordered">
                <div class="card-header">
                    <div class="card-title">CPU Load</div>
                </div>
                <div class="card-content">
                    <div class="metric-value" id="cpu-value">42%</div>
                    <div class="metric-label">Current Usage</div>
                    <div class="metric-bar">
                        <div class="metric-bar-fill cpu" id="cpu-bar" style="width: 42%;"></div>
                    </div>
                </div>
            </div>

            <div class="card bordered">
                <div class="card-header">
                    <div class="card-title">Memory Usage</div>
                </div>
                <div class="card-content">
                    <div class="metric-value" id="memory-value">68%</div>
                    <div class="metric-label">8.2GB / 12GB</div>
                    <div class="metric-bar">
                        <div class="metric-bar-fill memory" id="memory-bar" style="width: 68%;"></div>
                    </div>
                </div>
            </div>

            <div class="card bordered">
                <div class="card-header">
                    <div class="card-title">Disk Usage</div>
                </div>
                <div class="card-content">
                    <div class="metric-value" id="disk-value">35%</div>
                    <div class="metric-label">175GB / 500GB</div>
                    <div class="metric-bar">
                        <div class="metric-bar-fill disk" id="disk-bar" style="width: 35%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <script>
        // Global variables
        let refreshInterval = null;
        let currentRefreshRate = '10s';
        let socket = null;
        let isConnected = false;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            updateTimeOfDay();
            initializeSocketConnection();
        });

        // Initialize Socket.IO connection
        function initializeSocketConnection() {
            console.log('Initializing Socket.IO connection...');
            
            // Connect to dashboard namespace
            socket = io('/dashboard');

            // Connection events
            socket.on('connect', function() {
                console.log('Connected to dashboard server');
                isConnected = true;
                updateHeartbeat(true);
                
                // Connect to dashboard service
                socket.emit('connect_dashboard');
            });

            socket.on('disconnect', function() {
                console.log('Disconnected from dashboard server');
                isConnected = false;
                updateHeartbeat(false);
            });

            // Dashboard specific events
            socket.on('dashboard_connected', function(data) {
                console.log('Dashboard connected:', data);
                setRefreshRate(data.refresh_rate || '10s');
            });

            socket.on('basic_system_info', function(data) {
                console.log('Received basic system info:', data);
                updateBasicSystemInfo(data);
            });

            socket.on('system_metrics', function(data) {
                console.log('Received system metrics:', data);
                updateSystemMetrics(data);
                updateHeartbeat(true);
            });

            socket.on('refresh_rate_updated', function(data) {
                console.log('Refresh rate updated:', data.rate);
                currentRefreshRate = data.rate;
                document.getElementById('current-rate').textContent = data.rate;
            });

            socket.on('dashboard_error', function(error) {
                console.error('Dashboard error:', error);
                showError(error);
            });

            // Connection error handling
            socket.on('connect_error', function(error) {
                console.error('Connection error:', error);
                isConnected = false;
                updateHeartbeat(false);
                showError('Failed to connect to dashboard server');
            });
        }

        // Update heartbeat indicator
        function updateHeartbeat(connected) {
            const heartbeat = document.getElementById('heartbeat');
            if (heartbeat) {
                if (connected) {
                    heartbeat.style.backgroundColor = 'var(--green-primary)';
                    heartbeat.classList.add('connected'); // Add connected class for animation
                } else {
                    heartbeat.style.backgroundColor = '#ef4444'; // Red color for disconnected
                    heartbeat.classList.remove('connected'); // Remove connected class to stop animation
                }
            }
        }

        // Update basic system information (called once on connection)
        function updateBasicSystemInfo(info) {
            const ip = document.getElementById('current-ip');
            const hostname = document.getElementById('hostname');
            const username = document.getElementById('username');
            
            if (ip && info.ip) ip.textContent = info.ip;
            if (hostname && info.hostname) hostname.textContent = info.hostname;
            if (username && info.username) username.textContent = info.username;
        }

        // Update system metrics from Socket.IO data (only dynamic metrics)
        function updateSystemMetrics(metrics) {
            // Update CPU metrics
            if (metrics.cpu) {
                const cpuUsage = Math.round(metrics.cpu.usage);
                updateMetric('cpu', cpuUsage, cpuUsage + '%');
            }

            // Update memory metrics
            if (metrics.memory) {
                const memUsage = Math.round(metrics.memory.used_percent);
                const memLabel = `${metrics.memory.used} / ${metrics.memory.total}`;
                updateMetric('memory', memUsage, memUsage + '%', memLabel);
            }

            // Update disk metrics
            if (metrics.disk) {
                const diskUsage = Math.round(metrics.disk.used_percent);
                const diskLabel = `${metrics.disk.used} / ${metrics.disk.total}`;
                updateMetric('disk', diskUsage, diskUsage + '%', diskLabel);
            }
        }

        // Refresh data function
        function refreshData() {
            console.log('Manual refresh requested...');
            if (socket && isConnected) {
                socket.emit('refresh_data');
            } else {
                showError('Not connected to dashboard server');
            }
        }

        // Show error message
        function showError(message) {
            // You can implement a proper error display here
            console.error('Dashboard Error:', message);
            // For now, just show in console. You could add a toast notification here.
        }

        // Update individual metric
        function updateMetric(type, percentage, displayValue, labelValue) {
            const valueElement = document.getElementById(type + '-value');
            const barElement = document.getElementById(type + '-bar');
            
            if (valueElement) {
                valueElement.textContent = displayValue;
            } else {
                console.warn(`Element with id '${type}-value' not found`);
            }
            
            if (barElement) {
                barElement.style.width = percentage + '%';
            } else {
                console.warn(`Element with id '${type}-bar' not found`);
            }
            
            // Update label if provided (for memory and disk usage details)
            if (labelValue && valueElement) {
                const labelElement = valueElement.parentElement.querySelector('.metric-label');
                if (labelElement && type !== 'cpu') {
                    labelElement.textContent = labelValue;
                }
            }
        }

        // Update time of day greeting
        function updateTimeOfDay() {
            const hour = new Date().getHours();
            const timeOfDayElement = document.getElementById('time-of-day');
            
            if (hour < 12) {
                timeOfDayElement.textContent = 'morning';
            } else if (hour < 18) {
                timeOfDayElement.textContent = 'afternoon';
            } else {
                timeOfDayElement.textContent = 'evening';
            }
        }

        // Dropdown functionality
        function toggleDropdown() {
            const dropdown = document.getElementById('refreshDropdown');
            dropdown.classList.toggle('show');
        }

        // Set refresh rate
        function setRefreshRate(rate) {
            // Clear existing interval (not needed anymore with Socket.IO)
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }

            // Handle custom rate input
            if (rate === 'custom') {
                const customRate = prompt('Enter refresh rate in seconds:', '5');
                if (customRate && !isNaN(customRate) && customRate > 0) {
                    rate = customRate + 's';
                } else {
                    rate = 'OFF';
                }
            }

            // Update UI
            document.getElementById('current-rate').textContent = rate;
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('active');
                if (item.textContent === rate || (rate.endsWith('s') && item.textContent === 'custom')) {
                    item.classList.add('active');
                }
            });

            // Close dropdown
            document.getElementById('refreshDropdown').classList.remove('show');

            currentRefreshRate = rate;

            // Send refresh rate change to server via Socket.IO
            if (socket && isConnected) {
                socket.emit('set_refresh_rate', { rate: rate });
            } else {
                console.warn('Socket not connected, cannot set refresh rate');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.refresh-controls')) {
                document.getElementById('refreshDropdown').classList.remove('show');
            }
        });

        // Placeholder function to set username
        function setUsername(username) {
            document.getElementById('username').textContent = username || 'Administrator';
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>
